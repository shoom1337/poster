# Спецификация Telegram-бота: Общий обзор

## 1. Название и назначение бота
- **Название бота**: @poster1337_bot
- **Цель**: Бот для отложенного постинга в Телеграм
- **Целевая аудитория**: Авторы ТГ-каналов

## 2. Основные функции
Перечислите все основные возможности бота:
- [x] Функция 1: Создание, редактирование, предпросмотр и удаление постов
- [x] Функция 2: Управление датой и временем отправки постов
- [x] Функция 3: Просмотр аналитики по постам (количество просмотров, реакций, ответов)

## 3. Команды бота
Список всех команд, которые должен поддерживать бот:

| Команда | Описание | Права доступа |
|---------|----------|---------------|
| /start | Приветствие и описание возможностей | Администратор |
| /help | Справка по командам | Администратор |
| /newpost | Создать новый пост | Администратор |
| /editpost | Отредактировать существующий пост | Администратор |
| /drafts | Список черновиков | Администратор |
| /schedule | Календарь публикаций | Администратор |
| /statistics | Статистика по всем постам | Администратор |
| /channels | Управление каналами для публикации | Администратор |
| /cancel | Отменить текущее действие | Администратор |

## 4. Технические требования

### 4.1. Язык и фреймворк
- **Язык**: Node.js (TypeScript)
- **Библиотека**: Grammy (современная TypeScript-first библиотека для Telegram Bot API)
- **Версия**: Node.js 18+ LTS, TypeScript 5.3+
- **Дополнительные библиотеки**:
  - `grammy` - основной фреймворк для бота
  - `@grammyjs/conversations` - для многошаговых диалогов (создание/редактирование постов)
  - `@grammyjs/menu` - для inline-клавиатур
  - `@grammyjs/parse-mode` - для форматирования текста (HTML/Markdown)
  - `prisma` - ORM для работы с БД
  - `node-cron` - для планировщика публикаций
  - `date-fns` - для работы с датами в календаре
  - `nodemailer` - для отправки email уведомлений
  - `winston` - логирование
  - `winston-daily-rotate-file` - ротация логов

### 4.2. База данных
- **Тип БД**: PostgreSQL 15+
- **Что хранить**:
  - **Данные пользователя** (telegram_id, username, timezone, created_at)
  - **Каналы** (channel_id, channel_username, channel_title, date_added, is_active)
  - **Посты** (title, text, media_group, target_channel_id, status: draft/scheduled/published/failed)
  - **Расписание публикаций** (post_id, scheduled_at, published_at, status)
  - **Медиафайлы** (file_id из Telegram, file_type: photo/video/document, file_size, caption)
  - **Статистика постов** (post_id, views_count, forwards_count, last_updated_at)
  - **История действий** (action_type: created/edited/published/deleted, timestamp, post_id)
- **Связи**:
  - User (единственный админ) → Channels (один ко многим)
  - Channels → Posts (один ко многим)
  - Post → Media (один ко многим - media group)
  - Post → Schedule (один к одному)
  - Post → Statistics (один к одному)

### 4.3. Внешние API и интеграции
- [x] **Telegram Bot API** - основное взаимодействие с админом
- [x] **Telegram Channel API** - публикация постов в каналы через бота (бот должен быть админом каналов)
- [x] **Telegram getUpdates (Post Statistics)** - получение статистики по постам (views, forwards)
- [x] **Redis** - кеширование состояний conversations и временных данных при создании постов
- [x] **SMTP (Email)** - критические уведомления на email администратора
  - Использование Gmail SMTP или собственного SMTP сервера
  - Настройка через переменные окружения (SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS)
- **Тип подключения**: Long Polling (оптимально для домашнего сервера)
- **Автоматическая синхронизация статистики**: Cron job каждые 1-6 часов для обновления просмотров/репостов

### 4.4. Хостинг и деплой
- **Где будет размещен**: Домашний сервер
- **Требования к серверу**:
  - RAM: 1-2GB (Node.js + PostgreSQL + Redis)
  - CPU: 2 ядра (основной процесс + планировщик + синхронизация статистики)
  - Storage: 20GB (БД растет с медиа metadata + логи)
  - OS: Linux (Ubuntu 22.04 LTS / Debian 12)
  - Network: Стабильное интернет-соединение для Long Polling
- **Контейнеризация**: Docker + Docker Compose
  - Контейнер: Node.js приложение (bot + scheduler)
  - Контейнер: PostgreSQL 15
  - Контейнер: Redis 7 (для session storage)
  - Volume mounts для персистентности данных
- **Управление процессом**: Docker restart policy (always) + healthcheck
- **CI/CD**:
  - GitHub Actions для TypeScript компиляции и тестов
  - Webhook на сервере для авто-деплоя при push в main
  - Скрипт деплоя: `git pull && docker-compose build && docker-compose up -d`
- **Backup**:
  - PostgreSQL dump через pg_dump (cron: ежедневно в 3:00)
  - Ротация бэкапов (хранить 7 дней)
  - Опционально: загрузка бэкапов в облако (Яндекс.Диск / Google Drive)
- **Мониторинг**:
  - Winston для структурированных логов (JSON format)
  - Логи в файлы + ротация через winston-daily-rotate-file
  - Healthcheck endpoint (HTTP server на локальном порту)
  - Telegram-уведомления админу при критических ошибках (bot down, DB connection lost)
  - Метрики: uptime, posts published, errors count

## 5. Авторизация и безопасность
- [x] Доступ имеет только администратор, другие пользователи не могут взаимодействовать с ботом
- [x] Хранение токенов и секретов в .env файле (не коммитится в git)
- [x] Проверка ADMIN_TELEGRAM_ID при каждом запросе
- [x] Все секреты в переменных окружения:
  - `BOT_TOKEN` - токен Telegram бота
  - `ADMIN_TELEGRAM_ID` - ID администратора
  - `DATABASE_URL` - строка подключения к PostgreSQL
  - `REDIS_URL` - строка подключения к Redis
  - `SMTP_*` - настройки email
- [x] .env.example для документации требуемых переменных

## 6. Уведомления
- [x] **Telegram уведомления** (в ЛС администратору):
  - Ошибка публикации по расписанию
  - Критические ошибки бота (DB connection lost, bot crashed)
  - Успешная публикация поста (опционально, настраивается)
- [x] **Email уведомления** (для критических ситуаций):
  - Бот недоступен более 5 минут
  - Критическая ошибка базы данных
  - Заполнение диска более 90%
- [x] Настройки уведомлений можно включать/отключать через команды бота

## 7. Логирование и мониторинг
- [x] Логирование ошибок
- [x] Метрики использования
- [x] Система оповещения об ошибках

## 8. Ограничения и граничные случаи

### 8.1. Ограничения Telegram API
- **Максимальная длина текста поста**: 4096 символов
- **Максимальный размер фото**: 10 MB
- **Максимальный размер видео**: 50 MB
- **Максимальный размер документа**: 50 MB
- **Максимум медиа в media group**: 10 файлов
- **Форматирование**: HTML или Markdown (настраивается, по умолчанию HTML)

### 8.2. Поддержка форматирования текста
- [x] **HTML форматирование** (по умолчанию):
  - `<b>жирный</b>`, `<i>курсив</i>`, `<u>подчеркнутый</u>`
  - `<code>код</code>`, `<pre>блок кода</pre>`
  - `<a href="url">ссылка</a>`
  - `<spoiler>спойлер</spoiler>`
- [x] **Markdown** (альтернативно):
  - `**жирный**`, `*курсив*`, `__подчеркнутый__`
  - `` `код` ``, ` ```блок кода``` `
  - `[текст](url)`
- [x] Предпросмотр форматирования перед публикацией

### 8.3. Inline-кнопки под постами
- [x] Поддержка добавления inline-клавиатуры к посту
- [x] Типы кнопок:
  - URL кнопки (ссылки)
  - Callback кнопки (для интерактивности, если нужно)
- [x] Настройка количества кнопок в ряду (1-3 кнопки)
- [x] Предпросмотр кнопок перед публикацией

### 8.4. Граничные случаи
- **Превышение лимита символов**: Бот показывает текущее количество символов и предупреждает перед сохранением
- **Неверный формат даты/времени**: Бот просит ввести заново с примером правильного формата
- **Попытка публикации в прошлое**: Бот предупреждает и просит выбрать будущее время
- **Канал недоступен/бот не админ**: Уведомление с инструкцией по добавлению бота
- **Недоступность PostgreSQL**: Бот продолжает работу в read-only режиме с уведомлением
- **Недоступность Redis**: Conversations сохраняются в памяти (с предупреждением о перезапуске)
- **Отсутствие интернета**: Накопление постов в очереди, публикация после восстановления связи

## 9. Этапы разработки

### Этап 1: MVP (Минимальный функционал)
**Цель**: Базовая работоспособность бота для создания и публикации постов

- [x] Инициализация проекта (TypeScript + Grammy + Prisma)
- [x] Docker Compose конфигурация (PostgreSQL + Redis)
- [x] Базовая структура БД (User, Channel, Post, Media)
- [x] Авторизация администратора (проверка ADMIN_TELEGRAM_ID)
- [x] Команды: /start, /help, /newpost
- [x] Создание поста (только текст)
- [x] Добавление канала (/channels)
- [x] Публикация поста немедленно (без отложенной публикации)
- [x] Базовое логирование (Winston)

**Результат**: Бот может создать текстовый пост и опубликовать его в канал сразу

---

### Этап 2: Основной функционал
**Цель**: Полноценная работа с постами, расписанием и медиа

- [x] Поддержка медиафайлов (фото, видео, документы)
- [x] Media groups (несколько фото/видео в одном посте)
- [x] Планировщик публикаций (node-cron)
- [x] Календарь публикаций (/schedule)
  - Просмотр по дням/неделям
  - Отображение запланированных постов
- [x] Редактирование постов (/editpost)
- [x] Черновики (/drafts)
- [x] Удаление постов
- [x] Дублирование поста
- [x] HTML форматирование
- [x] Предпросмотр поста перед публикацией
- [x] Уведомления об ошибках публикации

**Результат**: Полноценный планировщик с медиа и управлением расписанием

---

### Этап 3: Аналитика и улучшения
**Цель**: Статистика, мониторинг и удобство использования

- [x] Статистика по постам (/statistics)
  - Просмотры (views)
  - Пересылки (forwards)
  - История обновления статистики
- [x] Cron job для синхронизации статистики
- [x] Inline-кнопки под постами
- [x] Управление несколькими каналами
- [x] Массовые операции в календаре:
  - Перенос нескольких постов
  - Удаление нескольких постов
- [x] Email уведомления (Nodemailer)
- [x] Healthcheck endpoint
- [x] Метрики: uptime, posts count, errors count
- [x] Backup скрипт для PostgreSQL

**Результат**: Production-ready бот с аналитикой и мониторингом

---

### Этап 4: Дополнительные возможности (опционально)
**Цель**: Расширенные функции для продвинутых пользователей

- [ ] Повторяющиеся публикации (ежедневно/еженедельно/ежемесячно)
- [ ] Шаблоны постов
- [ ] Markdown поддержка (переключение HTML/Markdown)
- [ ] Экспорт статистики в CSV/Excel
- [ ] Webhook для автодеплоя
- [ ] Web-интерфейс для просмотра статистики (опционально)
- [ ] Интеграция с другими платформами (VK, Instagram через API)

**Результат**: Максимально функциональный бот для профессионального использования

## 10. Дополнительные требования

### 10.1. Функционал календаря
- [x] **Отображение постов**:
  - По дням (список на выбранную дату)
  - По неделям (7 дней вперед)
  - По месяцам (календарная сетка с количеством постов)
- [x] **Навигация**: Inline-кнопки "Назад/Вперед" для перелистывания
- [x] **Фильтры**: По каналу, по статусу (запланировано/опубликовано/ошибка)
- [x] **Быстрые действия**: Клик на пост → меню (Просмотр/Редактировать/Удалить/Перенести)

### 10.2. Дублирование поста
- [x] Возможность создать копию существующего поста
- [x] Сохраняет текст, медиа, кнопки
- [x] Позволяет выбрать новый канал и время публикации
- [x] Доступно из меню поста

### 10.3. Работа с черновиками
- [x] Черновик создается автоматически при /newpost
- [x] Можно сохранить недописанный пост
- [x] Список черновиков с пагинацией
- [x] Возможность продолжить редактирование
- [x] Удаление черновика

### 10.4. Документация
- [x] README.md с инструкцией по установке и запуску
- [x] .env.example с описанием всех переменных
- [x] Документация API (если будет REST API)
- [x] Комментарии в коде (JSDoc для функций)

### 10.5. Тестирование
- [ ] Unit тесты для основных функций
- [ ] Integration тесты для БД
- [ ] E2E тесты для основных сценариев (опционально)
- [ ] GitHub Actions для автоматического запуска тестов

### 10.6. Мультиязычность
- [ ] Не требуется на первом этапе (только русский язык)
- [ ] Возможность добавить позже через i18n

### 10.7. Backup данных
- [x] Автоматический backup PostgreSQL (ежедневно в 3:00)
- [x] Ротация бэкапов (хранить 7 последних)
- [x] Скрипт восстановления из бэкапа
- [ ] Опционально: загрузка в облако (Яндекс.Диск/Google Drive)

### 10.8. Структура проекта
```
/poster-bot
├── /src
│   ├── /bot              # Grammy bot handlers
│   │   ├── commands/     # Команды (/start, /help, etc)
│   │   ├── conversations/# Диалоги (создание/редактирование)
│   │   ├── keyboards/    # Inline/Reply клавиатуры
│   │   └── middlewares/  # Авторизация, логирование
│   ├── /scheduler        # Cron jobs
│   │   ├── publisher.ts  # Публикация по расписанию
│   │   └── statistics.ts # Синхронизация статистики
│   ├── /services         # Business logic
│   │   ├── postService.ts
│   │   ├── channelService.ts
│   │   ├── statsService.ts
│   │   └── notificationService.ts
│   ├── /prisma           # DB schema & migrations
│   │   └── schema.prisma
│   ├── /utils            # Helpers
│   │   ├── logger.ts
│   │   ├── validators.ts
│   │   └── formatters.ts
│   └── index.ts          # Entry point
├── /docker
│   ├── Dockerfile
│   └── docker-compose.yml
├── /scripts
│   ├── backup.sh         # Backup PostgreSQL
│   └── restore.sh        # Restore from backup
├── .env.example
├── .gitignore
├── package.json
├── tsconfig.json
└── README.md
```

